<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hc.modules.lesson.mapper.LessonMapper">

   <resultMap id="lessonResultMap" type="com.hc.modules.lesson.entity.LessonEntity">
       <id property="id" column="id"/>
       <result property="name" column="name"/>
       <result property="classId" column="class_id"/>
       <result property="classHour" column="class_hour"/>
       <result property="status" column="status"/>
       <result property="startDate" column="start_date"/>
       <result property="endDate" column="end_date"/>
       <result property="lessonNow" column="lesson_now"/>
       <result property="createTime" column="create_time"/>
       <collection property="studentEntityList" ofType="com.hc.modules.student.entity.StudentEntity" javaType="ArrayList">
           <id property="id" column="s_id"/>
           <result property="name" column="s_name"/>
           <result property="gender" column="gender"/>
           <result property="birth" column="birth"/>
           <result property="guarder" column="guarder"/>
           <result property="guarderPhone" column="guarder_phone"/>
           <result property="createTime" column="create_time"/>
       </collection>
   </resultMap>

    <select id="getClassLessonList" resultMap="lessonResultMap">
        SELECT a.id,a.name,a.class_id,a.class_hour,a.status,a.start_date,a.end_date,a.lesson_now,a.create_time,
        c.id AS s_id, c.name AS s_name,c.gender,c.birth,c.guarder,c.guarder_phone
        FROM lesson a
        LEFT JOIN lesson_student b ON a.id = b.lesson_id
        LEFT JOIN student c ON b.student_id = c.id
        WHERE class_id=#{cid}
    </select>

    <insert id="insertLesson">
        INSERT INTO lesson(name,class_id,class_hour,start_date,end_date,lesson_now)
        VALUES (#{name},#{classId},#{classHour},#{startDate},#{endDate},lesson_now++)
    </insert>

    <insert id="insertLessonStudents">
        INSERT INTO lesson_student(lesson_id, student_id)
        VALUES
        <foreach collection ="list" item="item" separator ="," index="index">
            (#{coid}, #{item})
        </foreach >
    </insert>

    <select id="lessonSign" resultType="com.hc.modules.student.entity.CoursePackageEntity">
        SELECT * FROM course_package WHERE id =
        (SELECT c_p_id FROM class_student WHERE s_id=#{studentId} AND c_id =
        (SELECT class_id FROM lesson WHERE id = #{id}))
    </select>

    <update id="updateCoursePackage">
        UPDATE course_package SET consumed_class_hour=#{subtract} WHERE id=#{id}
    </update>

</mapper>
